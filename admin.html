 <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Dashboard - ANGCOMERCE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Arial;
  background:#111;
  color:white;
}

header{
  background:#000;
  padding:15px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.section{
  padding:20px;
}

.card{
  background:#1c1c1c;
  padding:15px;
  margin-bottom:15px;
  border-radius:10px;
}

button{
  padding:6px 10px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  margin-right:8px;
}

.approve{ background:#28a745; color:white; }
.reject{ background:#dc3545; color:white; }
.delete{ background:#ff4444; color:white; }

.stats{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
}

.stat-box{
  background:#1c1c1c;
  padding:20px;
  border-radius:10px;
  flex:1;
  min-width:150px;
}
</style>
</head>
<body>

<header>
  <h2>Admin Dashboard</h2>
  <button onclick="logout()">Logout</button>
</header>

<div class="section">

  <div class="stats">
    <div class="stat-box">
      <h3 id="totalMerchants">0</h3>
      <p>Commer√ßants</p>
    </div>
    <div class="stat-box">
      <h3 id="totalProducts">0</h3>
      <p>Produits</p>
    </div>
  </div>

  <h3>Commer√ßants en attente</h3>
  <div id="merchantList"></div>

  <h3>Tous les Produits</h3>
  <div id="productList"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
  getFirestore,
  collection,
  getDocs,
  doc,
  updateDoc,
  deleteDoc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB3rKXZjJqskewJM-cBvBRw8-ecJPvoeBw",
  authDomain: "angcomerce-v1.firebaseapp.com",
  projectId: "angcomerce-v1",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const merchantList = document.getElementById("merchantList");
const productList = document.getElementById("productList");

onAuthStateChanged(auth, async(user)=>{

  if(!user){
    window.location.href="merchant-login.html";
    return;
  }

  // üîê V√©rification r√¥le admin
  const adminRef = doc(db,"users",user.uid);
  const adminSnap = await getDoc(adminRef);

  if(!adminSnap.exists() || adminSnap.data().role !== "admin"){
    alert("Acc√®s refus√©. Vous n'√™tes pas admin.");
    window.location.href="index.html";
    return;
  }

  // Si admin confirm√©
  loadStats();
  loadMerchants();
  loadProducts();

});

async function loadStats(){
  const merchants = await getDocs(collection(db,"merchants"));
  const products = await getDocs(collection(db,"products"));

  document.getElementById("totalMerchants").innerText = merchants.size;
  document.getElementById("totalProducts").innerText = products.size;
}

async function loadMerchants(){

  const snapshot = await getDocs(collection(db,"merchants"));
  merchantList.innerHTML="";

  snapshot.forEach(docSnap=>{
    const data = docSnap.data();

    if(data.approved === false){
      merchantList.innerHTML += `
        <div class="card">
          ${data.email}<br><br>
          <button class="approve" onclick="approve('${docSnap.id}')">Approuver</button>
          <button class="reject" onclick="ban('${docSnap.id}')">Refuser</button>
        </div>
      `;
    }
  });
}

window.approve = async(id)=>{
  await updateDoc(doc(db,"merchants",id),{
    approved:true
  });
  alert("Commer√ßant valid√© !");
  loadMerchants();
  loadStats();
};

window.ban = async(id)=>{
  if(confirm("Supprimer ce commer√ßant ?")){
    await deleteDoc(doc(db,"merchants",id));
    loadMerchants();
    loadStats();
  }
};

async function loadProducts(){

  const snapshot = await getDocs(collection(db,"products"));
  productList.innerHTML="";

  snapshot.forEach(docSnap=>{
    const data = docSnap.data();

    productList.innerHTML += `
      <div class="card">
        <b>${data.name}</b> - ${data.price} Kz<br><br>
        <button class="delete" onclick="deleteProduct('${docSnap.id}')">
          Supprimer
        </button>
      </div>
    `;
  });
}

window.deleteProduct = async(id)=>{
  if(confirm("Supprimer ce produit ?")){
    await deleteDoc(doc(db,"products",id));
    loadProducts();
    loadStats();
  }
};

window.logout = ()=>{
  signOut(auth).then(()=>{
    window.location.href="index.html";
  });
};

</script>

</body>
</html>
