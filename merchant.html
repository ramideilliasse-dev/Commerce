 <!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Espace Commerçant</title>
</head>
<body>

<h2>Publier un produit</h2>

<input type="text" id="name" placeholder="Nom du produit"><br><br>
<input type="number" id="price" placeholder="Prix"><br><br>
<textarea id="description" placeholder="Description"></textarea><br><br>

<input type="file" id="images" multiple><br><br>

<button onclick="publishProduct()">Publier</button>

<p id="message"></p>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB3rKXZjJqskewJM-cBvBRw8-ecJPvoeBw",
  authDomain: "angcomerce-v1.firebaseapp.com",
  projectId: "angcomerce-v1",
  storageBucket: "angcomerce-v1.firebasestorage.app",
  messagingSenderId: "238735890157",
  appId: "1:238735890157:web:db3f87960db7916d7fdee4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
  } else {
    alert("Vous devez vous connecter.");
    window.location.href = "merchant-register.html";
  }
});
window.publishProduct = async function() {

  try {

    if (!currentUser) {
      alert("Utilisateur non connecté.");
      return;
    }

    const name = document.getElementById("name").value;
    const price = document.getElementById("price").value;
    const description = document.getElementById("description").value;
    const files = document.getElementById("images").files;

    if (!name || !price || files.length === 0) {
      alert("Veuillez remplir tous les champs.");
      return;
    }

    document.getElementById("message").innerText = "Upload en cours...";

    let imageUrls = [];

    for (let i = 0; i < files.length; i++) {

      const formData = new FormData();
      formData.append("file", files[i]);
      formData.append("upload_preset", "angcomerce-upload");

      const response = await fetch("https://api.cloudinary.com/v1_1/df2oxw2qp/image/upload", {
        method: "POST",
        body: formData
      });

      const data = await response.json();
      imageUrls.push(data.secure_url);
    }

    const docRef = await addDoc(collection(db, "products"), {
      name: name,
      price: price,
      description: description,
      images: imageUrls,
      merchantId: currentUser.uid,
      createdAt: new Date()
    });

    console.log("Document écrit avec ID:", docRef.id);

    document.getElementById("message").innerText = "Produit publié avec succès !";

  } catch (error) {

    console.error("Erreur Firestore :", error);
    document.getElementById("message").innerText = "Erreur : " + error.message;

  }

};

</script>

</body>
</html>   
