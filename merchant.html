 <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dashboard Marchand</title>
</head>
<body>

<h2 id="welcome"></h2>

<div id="dashboard">

  <h3>Ajouter un produit</h3>

  <input id="productName" placeholder="Nom du produit"><br><br>
  <input id="productPrice" placeholder="Prix"><br><br>
  <textarea id="productDescription" placeholder="Description"></textarea><br><br>

  <input type="file" id="productImages" multiple><br><br>

  <button id="addBtn" onclick="addProduct()">
    Ajouter
  </button>

  <hr>

  <h3>Mes produits</h3>
  <div id="myProducts"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  query, 
  where, 
  getDocs,
  deleteDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB3rKXZjJqskewJM-cBvBRw8-ecJPvoeBw",
  authDomain: "angcomerce-v1.firebaseapp.com",
  projectId: "angcomerce-v1",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

const welcome = document.getElementById("welcome");

onAuthStateChanged(auth, (user) => {

  if (!user) {
    window.location.href = "index.html";
    return;
  }

  currentUser = user;
  welcome.innerText = "Bienvenue " + user.email;

  loadMyProducts();
});

/* ================= AJOUT PRODUIT ULTRA RAPIDE ================= */

window.addProduct = async function() {

  const btn = document.getElementById("addBtn");
  btn.disabled = true;
  btn.innerText = "Upload en cours...";

  const name = document.getElementById("productName").value;
  const price = document.getElementById("productPrice").value;
  const description = document.getElementById("productDescription").value;
  const files = document.getElementById("productImages").files;

  if (!name || !price || !description || files.length === 0) {
    alert("Remplis tous les champs");
    btn.disabled = false;
    btn.innerText = "Ajouter";
    return;
  }

  try {

    // üî• Upload images en parall√®le (beaucoup plus rapide)
    const uploadPromises = [];

    for (let i = 0; i < files.length; i++) {

      const formData = new FormData();
      formData.append("file", files[i]);
      formData.append("upload_preset", "angcomerce-upload");

      uploadPromises.push(
        fetch("https://api.cloudinary.com/v1_1/df2oxw2qp/image/upload", {
          method: "POST",
          body: formData
        }).then(res => res.json())
      );
    }

    const uploadResults = await Promise.all(uploadPromises);
    const imageUrls = uploadResults.map(data => data.secure_url);

    // üî• Ajout dans Firestore
    await addDoc(collection(db, "products"), {
      name,
      price: Number(price),
      description,
      images: imageUrls,
      merchantId: currentUser.uid,
      merchantPhone: currentUser.email,
      merchantCity: "Luanda",
      createdAt: new Date()
    });

    alert("Produit ajout√© avec succ√®s !");
    loadMyProducts();

    // Reset champs
    document.getElementById("productName").value = "";
    document.getElementById("productPrice").value = "";
    document.getElementById("productDescription").value = "";
    document.getElementById("productImages").value = "";

  } catch (error) {
    alert("Erreur : " + error.message);
  }

  btn.disabled = false;
  btn.innerText = "Ajouter";
};

/* ================= MES PRODUITS ================= */

async function loadMyProducts() {

  const q = query(
    collection(db, "products"),
    where("merchantId", "==", currentUser.uid)
  );

  const snapshot = await getDocs(q);

  const container = document.getElementById("myProducts");
  container.innerHTML = "";

  snapshot.forEach(docSnap => {

    const data = docSnap.data();
    const productId = docSnap.id;

    let imagesHTML = "";

    if (data.images) {
      data.images.forEach(img => {
        imagesHTML += `<img src="${img}" width="60" style="margin:5px;border-radius:6px;">`;
      });
    }

    container.innerHTML += `
      <div style="
        background:white;
        padding:15px;
        margin:15px 0;
        border-radius:12px;
        box-shadow:0 5px 15px rgba(0,0,0,0.1);
      ">
        <p><strong>${data.name}</strong></p>
        <p>${data.description}</p>
        <p><strong>${data.price} Kz</strong></p>
        <div>${imagesHTML}</div>

        <button onclick="deleteProduct('${productId}')" 
          style="
            margin-top:10px;
            background:red;
            color:white;
            border:none;
            padding:8px 12px;
            border-radius:8px;
            cursor:pointer;
          ">
          Supprimer
        </button>
      </div>
    `;
  });
}

/* ================= SUPPRESSION ================= */

window.deleteProduct = async function(productId){

  const confirmDelete = confirm("Voulez-vous supprimer ce produit ?");

  if(!confirmDelete) return;

  await deleteDoc(doc(db,"products",productId));

  alert("Produit supprim√© avec succ√®s");

  loadMyProducts();
};

</script>

</body>
</html>
