 <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dashboard Marchand</title>
</head>
<body>

<h2 id="welcome"></h2>
<div id="status"></div>

<div id="dashboard" style="display:none;">

  <h3>Ajouter un produit</h3>

  <input id="productName" placeholder="Nom du produit"><br><br>
  <input id="productPrice" type="number" placeholder="Prix"><br><br>
  <textarea id="productDescription" placeholder="Description"></textarea><br><br>

  <input type="file" id="productImages" multiple><br><br>

  <select id="productCategory">
    <option value="">Choisir une catégorie</option>
    <option value="Electronique">Electronique</option>
    <option value="Vêtements">Vêtements</option>
    <option value="Chaussures">Chaussures</option>
    <option value="Maison">Maison</option>
    <option value="Beauté">Beauté</option>
    <option value="Autre">Autre</option>
  </select>
  <br><br>

  <button onclick="addProduct()">Ajouter</button>

  <hr>

  <h3>Mes produits</h3>
  <div id="myProducts"></div>

  <hr>

  <h3>Mes Commandes</h3>
  <div id="merchantOrders"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc, 
  collection, 
  addDoc, 
  query, 
  where, 
  getDocs,
  updateDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB3rKXZjJqskewJM-cBvBRw8-ecJPvoeBw",
  authDomain: "angcomerce-v1.firebaseapp.com",
  projectId: "angcomerce-v1",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

const welcome = document.getElementById("welcome");
const statusDiv = document.getElementById("status");
const dashboard = document.getElementById("dashboard");

onAuthStateChanged(auth, async (user) => {

  if (!user) {
    window.location.href = "index.html";
    return;
  }

  currentUser = user;
  welcome.innerText = "Bienvenue " + user.email;

  const merchantDoc = await getDoc(doc(db, "merchants", user.uid));

  if (!merchantDoc.exists() || merchantDoc.data().verified !== true) {

    statusDiv.innerHTML = `
      <h3 style="color:red;">
        Votre compte est en attente de validation.
      </h3>
    `;

  } else {

    statusDiv.innerHTML = `
      <h3 style="color:green;">Compte validé ✅</h3>
    `;

    dashboard.style.display = "block";
    loadMyProducts();
    loadMerchantOrders();
  }

});


// =========================
// AJOUT PRODUIT
// =========================

window.addProduct = async function() {

  const name = document.getElementById("productName").value.trim();
  const price = document.getElementById("productPrice").value;
  const description = document.getElementById("productDescription").value.trim();
  const category = document.getElementById("productCategory").value;
  const files = document.getElementById("productImages").files;

  if (!name || !price || !description || !category || files.length === 0) {
    alert("Remplis tous les champs");
    return;
  }

  let imageUrls = [];

  for (let i = 0; i < files.length; i++) {

    const formData = new FormData();
    formData.append("file", files[i]);
    formData.append("upload_preset", "angcomerce-upload");

    const response = await fetch(
      "https://api.cloudinary.com/v1_1/df2oxw2qp/image/upload",
      {
        method: "POST",
        body: formData
      }
    );

    const data = await response.json();
    imageUrls.push(data.secure_url);
  }

  await addDoc(collection(db, "products"), {
    name,
    price: Number(price),
    description,
    images: imageUrls,
    category,
    merchantId: currentUser.uid,
    createdAt: new Date()
  });

  alert("Produit ajouté !");
  loadMyProducts();
};


// =========================
// MES PRODUITS
// =========================

async function loadMyProducts() {

  const q = query(
    collection(db, "products"),
    where("merchantId", "==", currentUser.uid)
  );

  const snapshot = await getDocs(q);

  const container = document.getElementById("myProducts");
  container.innerHTML = "";

  snapshot.forEach(docSnap => {

    const data = docSnap.data();

    let imagesHTML = "";
    if (data.images) {
      data.images.forEach(img => {
        imagesHTML += `<img src="${img}" width="80" style="margin:5px;">`;
      });
    }

    container.innerHTML += `
      <div style="border:1px solid black; padding:10px; margin:10px;">
        <p><strong>${data.name}</strong></p>
        <p>${data.description}</p>
        <p>Prix : ${data.price} Kz</p>
        <div>${imagesHTML}</div>

        <button onclick="deleteProduct('${docSnap.id}')">
          Supprimer
        </button>

      </div>
    `;
  });
}


// =========================
// SUPPRESSION PRODUIT
// =========================

window.deleteProduct = async function(productId){

  if(confirm("Supprimer ce produit ?")){

    await deleteDoc(doc(db, "products", productId));

    alert("Produit supprimé");

    loadMyProducts();
  }
}


// =========================
// COMMANDES MARCHAND
// =========================

async function loadMerchantOrders() {

  const q = query(
    collection(db, "orders"),
    where("merchantId", "==", currentUser.uid)
  );

  const snapshot = await getDocs(q);

  const container = document.getElementById("merchantOrders");
  container.innerHTML = "";

  if (snapshot.empty) {
    container.innerHTML = "<p>Aucune commande pour le moment.</p>";
    return;
  }

  snapshot.forEach(docSnap => {

    const data = docSnap.data();

    container.innerHTML += `
      <div style="border:1px solid green; padding:10px; margin:10px;">
        <p><strong>Produit :</strong> ${data.productId}</p>
        <p><strong>Quantité :</strong> ${data.quantity}</p>
        <p><strong>Status :</strong> ${data.status}</p>

        <button onclick="updateOrderStatus('${docSnap.id}', 'Validée')">
          Valider
        </button>

        <button onclick="updateOrderStatus('${docSnap.id}', 'Expédiée')">
          Expédier
        </button>

      </div>
    `;
  });
}


// =========================
// UPDATE STATUS
// =========================

window.updateOrderStatus = async function(orderId, newStatus) {

  await updateDoc(doc(db, "orders", orderId), {
    status: newStatus
  });

  alert("Statut mis à jour !");
  loadMerchantOrders();
};

</script>

</body>
</html>
